(function(){(function(){const f=document.createElement("style");f.textContent=`.divee-widget{--divee-color-primary: #68E5FD;--divee-color-secondary: #A389E0;all:initial;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif!important;width:100%!important;max-width:800px!important;margin:40px auto!important;box-shadow:0 2px 8px #0000001a!important;border-radius:12px!important;overflow:hidden!important;background:#fff!important;border:1px solid #e5e7eb!important;display:block!important;box-sizing:border-box!important}.divee-widget-floating{position:fixed!important;z-index:999999!important;margin:0!important;max-width:500px!important;width:400px!important}.divee-widget-floating[data-state=collapsed]{width:auto!important;max-width:none!important;border-radius:50px!important;box-shadow:0 4px 20px #00000026!important}.divee-widget-floating[data-state=expanded]{width:500px!important;height:auto!important;max-height:90vh!important;border-radius:16px!important;box-shadow:0 8px 32px #0003!important}.divee-widget-floating .divee-expanded{max-height:85vh!important;height:auto!important}.divee-widget-floating[data-floating-position=bottom-right]{bottom:24px!important;right:24px!important}.divee-widget-floating[data-floating-position=bottom-left]{bottom:24px!important;left:24px!important}.divee-widget-floating .divee-collapsed{padding:12px 20px!important;margin:0!important}.divee-widget-floating .divee-search-container-collapsed{margin-bottom:0!important;min-width:280px!important}.divee-widget-floating .divee-powered-by-collapsed{display:none!important}.divee-widget *{box-sizing:border-box!important}.divee-widget input,.divee-widget textarea,.divee-widget button{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif!important}.divee-widget[dir=rtl]{direction:rtl}.divee-widget[dir=rtl] .divee-icons,.divee-widget[dir=rtl] .divee-input-container,.divee-widget[dir=rtl] .divee-input-footer{flex-direction:row-reverse}.divee-widget[dir=rtl] .divee-send{order:-1}.divee-widget[dir=rtl] .divee-send svg,.divee-widget[dir=rtl] .divee-send-icon-collapsed{transform:scaleX(-1)}.divee-widget[dir=rtl] .divee-input{order:0}.divee-widget[dir=rtl] .divee-message-user{align-self:flex-start;align-items:flex-start}.divee-widget[dir=rtl] .divee-message-ai{align-self:flex-end;align-items:flex-start;flex-direction:row-reverse}.divee-widget[dir=rtl] .divee-message-user .divee-message-content{border-bottom-left-radius:4px;border-bottom-right-radius:16px}.divee-widget[dir=rtl] .divee-message-ai .divee-message-content{border-bottom-right-radius:4px;border-bottom-left-radius:16px}.divee-widget[dir=rtl] .divee-warning{text-align:right}.divee-widget[dir=rtl] .divee-counter{text-align:left}.divee-widget[dir=rtl] .divee-cursor{margin-right:2px;margin-left:0}.divee-collapsed{background:#fff;padding:24px;cursor:pointer;transition:all .3s ease-in-out;opacity:1}.divee-collapsed:hover{background:#fafafa}.divee-search-container-collapsed{display:flex;align-items:center;gap:12px;background:linear-gradient(#fff,#fff) padding-box,linear-gradient(135deg,var(--divee-color-primary),var(--divee-color-secondary)) border-box;border:2px solid transparent;border-radius:40px;padding:12px 16px;margin-bottom:16px;transition:all .3s;box-shadow:0 2px 6px #68e5fd14,0 1px 2px #a389e00d}.divee-search-container-collapsed:hover{background:linear-gradient(#fff,#fff) padding-box,linear-gradient(135deg,var(--divee-color-primary),#FD3C4F) border-box;border:2px solid transparent;box-shadow:0 4px 12px #68e5fd26,0 2px 4px #a389e014;transform:translateY(-1px)}.divee-icon-ai-collapsed,.divee-icon-site-collapsed{flex-shrink:0}.divee-icon-ai-collapsed{width:24px;height:24px;color:var(--divee-color-secondary);transition:all .3s}.divee-search-container-collapsed:hover .divee-icon-ai-collapsed{filter:drop-shadow(0 0 4px rgba(163,137,224,.3));transform:rotate(5deg) scale(1.1)}.divee-icon-site-collapsed{width:24px;height:24px;border-radius:50%;object-fit:cover;transition:all .3s}.divee-search-container-collapsed:hover .divee-icon-site-collapsed{border-color:#fd3c4f;box-shadow:0 2px 6px #fd3c4f26;transform:scale(1.1)}.divee-widget .divee-search-input-collapsed{flex:1!important;border:none!important;background:transparent!important;outline:none!important;font-size:18px!important;color:#1f2937!important;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif!important;overflow:hidden!important;text-overflow:ellipsis!important;white-space:nowrap!important;min-width:0!important;padding:0!important;margin:0!important;height:auto!important;line-height:1.5!important;box-shadow:none!important;appearance:none!important;-webkit-appearance:none!important;-moz-appearance:none!important;border-radius:0!important}.divee-widget .divee-search-input-collapsed::placeholder{color:#6b7280!important}@keyframes typewriter{0%{width:0}to{width:100%}}@keyframes blink{50%{border-color:transparent}}.divee-search-input-collapsed.typewriter-active{border-right:2px solid var(--divee-color-secondary);animation:blink .7s step-end infinite;width:100%;overflow:hidden;white-space:nowrap}.divee-send-icon-collapsed{width:22px;height:22px;color:#4b5563;flex-shrink:0;transition:all .3s}.divee-search-container-collapsed:hover .divee-send-icon-collapsed{filter:drop-shadow(0 0 4px rgba(75,85,99,.25));transform:translate(2px) scale(1.15)}.divee-powered-by-collapsed{padding:0 24px 6px;text-align:left;direction:ltr}.divee-header{display:flex;flex-direction:column;gap:0px;margin-bottom:8px;padding:16px 20px 10px;background:linear-gradient(#fff,#fff) padding-box,linear-gradient(135deg,var(--divee-color-primary),var(--divee-color-secondary)) border-box;border-bottom:2px solid transparent;background-clip:padding-box,border-box;background-origin:padding-box,border-box}.divee-header-top{display:flex;align-items:center;gap:12px}.divee-powered-by-wrapper{padding:0 0 0 14px;margin-top:3px;text-align:left;direction:ltr}.divee-powered-by{font-size:12px;color:#9ca3af;text-decoration:none;padding:0 6px;display:inline-block;margin-left:auto;white-space:nowrap;flex-shrink:0}.divee-powered-by:hover{color:#6b7280;text-decoration:underline}.divee-icons{display:flex;align-items:center;gap:10px}.divee-icon-ai,.divee-icon-site{display:flex;align-items:center;justify-content:center;flex-shrink:0}.divee-icon-ai{width:32px;height:32px;color:var(--divee-color-secondary)}.divee-icon-site{width:32px;height:32px;border-radius:50%;object-fit:cover}.divee-title{font-weight:600;font-size:16px;color:#1f2937;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.divee-close{background:none;border:none;font-size:20px;color:#6b7280;cursor:pointer;padding:4px 8px;line-height:1;border-radius:4px;transition:background .2s}.divee-close:hover{background:#f3f4f6}.divee-ad-container-shared{width:100%;display:block;background:#fff;padding:0;margin:0}.divee-ad-slot{margin:12px 0;min-height:100px;display:flex;align-items:center;justify-content:center}.divee-widget[data-state=collapsed] .divee-ad-container-shared,.divee-widget[data-state=expanded] .divee-ad-container-shared{display:block!important}.divee-ad-desktop{display:block}.divee-ad-mobile{display:none}.divee-expanded{background:#fff;display:flex;flex-direction:column;max-height:600px;overflow:hidden;transition:opacity .3s ease-in-out,transform .3s ease-in-out;opacity:1;transform:translateY(0)}.divee-widget[data-state=collapsed] .divee-expanded{display:none!important}.divee-widget[data-state=expanded] .divee-expanded{display:flex!important}.divee-widget[data-state=expanded] .divee-collapsed{display:none!important}.divee-content{flex:1;min-height:0;overflow:visible;padding:14px;display:flex;flex-direction:column;gap:4px}.divee-suggestions-input{position:absolute;bottom:100%;left:0;right:0;margin-bottom:12px;background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 4px 20px #00000026;z-index:100;overflow:hidden;transform-origin:bottom center;animation:divee-slide-up-fade .3s ease-out}.divee-suggestions-input:not(.is-open){display:none!important}.divee-suggestions-list{display:flex;flex-direction:column;padding:8px;max-height:220px;overflow-y:auto}.divee-suggestion{background:#fff;border:1px solid transparent;padding:10px 14px;border-radius:8px;text-align:left;font-size:13px;color:#374151;cursor:pointer;transition:all .2s;display:block;width:100%;animation:none;opacity:1}.divee-suggestion:hover{background:#f3f4f6;color:#111827;border-color:#e5e7eb}.divee-widget[dir=rtl] .divee-suggestion{text-align:right;direction:rtl}@keyframes divee-slide-up-fade{0%{opacity:0;transform:translateY(10px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}.divee-loading{padding:12px;text-align:center;color:#6b7280;font-size:14px}.divee-shimmer-line{height:14px;background:linear-gradient(90deg,#f3f4f6,#e5e7eb,#f3f4f6);background-size:200% 100%;border-radius:4px;animation:divee-shimmer 1.5s ease-in-out infinite;width:85%}.divee-loading-item{pointer-events:none;cursor:default;margin-bottom:4px}.divee-loading-item:nth-child(2) .divee-shimmer-line{width:92%}.divee-loading-item:nth-child(3) .divee-shimmer-line{width:78%}.divee-shimmer-line:last-child{margin-bottom:0}@keyframes divee-shimmer{0%{background-position:200% 0}to{background-position:-200% 0}}.divee-error{padding:12px;text-align:center;color:#ef4444;font-size:14px}.divee-chat{height:280px;overflow-y:scroll!important;overflow-x:hidden;scroll-behavior:smooth;margin-bottom:2px;border:1px solid #e5e7eb;border-radius:12px;padding:12px;display:flex;flex-direction:column}.divee-messages{display:flex;flex-direction:column;gap:12px;flex:1}.divee-empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#6b7280;text-align:center;padding:20px;gap:12px;animation:divee-fade-in .3s ease;margin:auto}.divee-empty-icon{width:48px;height:48px;margin-bottom:4px;display:flex;align-items:center;justify-content:center;background:#f3f4f6;border-radius:50%;color:var(--divee-color-secondary)}.divee-empty-icon img{width:100%;height:100%;border-radius:50%;object-fit:cover}.divee-empty-text{font-size:14px;line-height:1.5;max-width:260px;color:#6b7280}.divee-message{display:flex;flex-direction:column;gap:4px;animation:divee-fade-in .2s ease;max-width:85%}.divee-message-user{align-self:flex-end;align-items:flex-end}.divee-message-ai{align-self:flex-start;flex-direction:row;align-items:flex-start;gap:8px}.divee-message-label{font-size:11px;font-weight:600;color:#9ca3af;text-transform:uppercase;letter-spacing:.5px;padding:0 8px;display:flex;align-items:center;gap:6px;flex-shrink:0}.divee-message-ai .divee-message-label{padding:0;margin-top:0}.divee-message-icon{width:28px;height:28px;border-radius:999px;object-fit:cover;border:1px solid rgba(148,163,184,.4)}.divee-message-content{padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.5;white-space:pre-wrap;word-wrap:break-word;box-shadow:0 1px 2px #0000000d}.divee-message-user .divee-message-content{background:linear-gradient(135deg,var(--divee-color-primary) 0%,var(--divee-color-secondary) 100%);color:#fff;border-bottom-right-radius:4px}.divee-message-ai .divee-message-content{background:#f3f4f6;color:#1f2937;border-bottom-left-radius:4px;border:1px solid #e5e7eb}.divee-cursor{color:var(--divee-color-primary);flex-wrap:wrap;-blink 1s infinite;margin-left:2px}.divee-input-container{display:flex;align-items:flex-start;padding:10px 0 0;background:#fff;position:relative;flex-wrap:wrap;gap:10px}.divee-input-footer{display:flex;justify-content:space-between;align-items:center;width:100%;flex:0 0 100%;margin-top:0;gap:8px}.divee-warning{font-size:11px;color:#9ca3af;text-align:left}.divee-counter{font-size:11px;color:#9ca3af;text-align:right;white-space:nowrap;flex-shrink:0}.divee-widget .divee-input{flex:1!important;background:linear-gradient(#fff,#fff) padding-box,linear-gradient(135deg,var(--divee-color-primary),var(--divee-color-secondary)) border-box!important;border:2px solid transparent!important;border-radius:40px!important;padding:10px 22px!important;font-size:14px!important;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif!important;resize:none!important;max-height:100px!important;min-height:auto!important;outline:none!important;transition:all .3s!important;overflow:hidden!important;height:auto!important;margin:0!important;box-shadow:none!important;appearance:none!important;-webkit-appearance:none!important;-moz-appearance:none!important;line-height:1.5!important}.divee-widget .divee-input:focus{background:linear-gradient(#fff,#fff) padding-box,linear-gradient(135deg,var(--divee-color-primary),#FD3C4F) border-box!important;border:2px solid transparent!important;box-shadow:0 4px 12px #68e5fd26,0 2px 4px #a389e014!important}.divee-widget .divee-input::placeholder{color:#9ca3af!important}.divee-send{background:linear-gradient(135deg,var(--divee-color-primary) 0%,var(--divee-color-secondary) 100%);color:#fff;border:none;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;flex-shrink:0;margin-top:4px;box-shadow:0 2px 6px #68e5fd4d}.divee-send svg{width:20px;height:20px;fill:#fff}.divee-send:hover{transform:scale(1.1);box-shadow:0 4px 12px #68e5fd66}.divee-send:disabled{background:#d1d5db;cursor:not-allowed}@keyframes divee-fade-in{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@keyframes divee-slide-up{0%{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@keyframes divee-blink{0%,50%{opacity:1}51%,to{opacity:0}}@keyframes slideInLTR{0%{opacity:0;transform:translate(20px)}to{opacity:1;transform:translate(0)}}@keyframes slideInRTL{0%{opacity:0;transform:translate(-20px)}to{opacity:1;transform:translate(0)}}.divee-suggestion-card{display:flex;position:relative;width:100%;max-width:100%;padding:10px;margin:7px 0;border:1px solid #e5e7eb;border-left:3px solid var(--divee-color-secondary);border-radius:7px;background:linear-gradient(135deg,color-mix(in srgb,var(--divee-color-primary) 3%,transparent),color-mix(in srgb,var(--divee-color-secondary) 5%,transparent));box-shadow:0 3px 10px #0000001f;cursor:pointer;transition:all .2s ease-out;animation:slideInLTR .3s ease-out;box-sizing:border-box;outline:none}[dir=rtl] .divee-suggestion-card{animation:slideInRTL .3s ease-out}@media(hover:hover){.divee-suggestion-card:hover{transform:translateY(-2px) scale(1.01);box-shadow:0 6px 20px #0000002e;border-left-color:var(--divee-color-primary)}}.divee-suggestion-card:focus{outline:2px solid #3B82F6;outline-offset:2px}.divee-suggestion-card:active{transform:translateY(0);opacity:.9}.divee-suggestion-image{width:60px;height:100%;flex-shrink:0;margin-right:12px;border-radius:5px;overflow:hidden;background:#e5e7eb}.divee-suggestion-image img{width:100%;height:100%;object-fit:cover;object-position:center;display:block}@media(max-width:400px){.divee-suggestion-image{width:48px;margin-right:10px}}.divee-suggestion-text{flex:1;display:flex;flex-direction:column;justify-content:flex-start;min-width:0}.divee-suggestion-label{font-size:8px;font-weight:500;color:#6b7280;letter-spacing:.3px;text-transform:uppercase;margin-bottom:5px;line-height:1.1}[dir=rtl] .divee-suggestion-label{text-align:right;direction:rtl}.divee-suggestion-title{font-size:14px;font-weight:600;color:#1f2937;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis;max-height:2.6em;word-break:break-word}[dir=rtl] .divee-suggestion-title{text-align:right;direction:rtl}@media(max-width:400px){.divee-suggestion-title{font-size:13px;-webkit-line-clamp:2;max-height:2.6em}}.divee-suggestion-dismiss{position:absolute;top:7px;right:7px;width:19px;height:19px;color:#9ca3af;font-size:17px;background:transparent;border:none;cursor:pointer;transition:color .15s ease;display:flex;align-items:center;justify-content:center;padding:0;z-index:10}.divee-suggestion-dismiss:hover{color:#374151}.divee-suggestion-dismiss:focus{outline:2px solid #3B82F6;outline-offset:2px;border-radius:2px}.divee-suggestion-dismissing{flex-direction:column;align-items:center;cursor:default}.divee-suggestion-dismissing:hover{transform:none;box-shadow:none}.divee-suggestion-confirm{text-align:center}.divee-suggestion-confirm-title{font-size:15px;font-weight:600;color:#1f2937;margin:0 0 4px}.divee-suggestion-confirm-subtitle{font-size:13px;color:#6b7280;font-style:italic;margin:0 0 20px}.divee-suggestion-confirm-actions{display:flex;gap:12px;justify-content:center}.divee-btn-ghost{padding:8px 16px;border:1px solid #D1D5DB;border-radius:6px;background:transparent;color:#6b7280;font-size:14px;font-weight:500;cursor:pointer;transition:background .15s ease}.divee-btn-ghost:hover{background:#f9fafb}.divee-btn-ghost:focus{outline:2px solid #3B82F6;outline-offset:2px}.divee-btn-primary{padding:8px 16px;border:none;border-radius:6px;background:#3b82f6;color:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:background .15s ease}.divee-btn-primary:hover{background:#2563eb}.divee-btn-primary:focus{outline:2px solid #3B82F6;outline-offset:2px}.divee-content::-webkit-scrollbar,.divee-chat::-webkit-scrollbar{width:10px}.divee-content::-webkit-scrollbar-track,.divee-chat::-webkit-scrollbar-track{background:#f3f4f6;border-radius:8px}.divee-content::-webkit-scrollbar-thumb,.divee-chat::-webkit-scrollbar-thumb{background:var(--divee-color-secondary);border-radius:8px}.divee-content::-webkit-scrollbar-thumb:hover,.divee-chat::-webkit-scrollbar-thumb:hover{background:#8b6bc9}@media(max-width:768px){.divee-expanded{max-height:75vh}.divee-icon-ai-collapsed{display:none}.divee-search-input-collapsed{font-size:15px}.divee-ad-desktop{display:none!important}.divee-ad-mobile{display:block!important}.divee-widget-floating[data-state=collapsed]{width:56px!important;height:56px!important;border-radius:50%!important}.divee-widget-floating .divee-collapsed{padding:0!important;display:flex!important;align-items:center!important;justify-content:center!important;width:56px!important;height:56px!important;margin:0!important}.divee-widget-floating .divee-search-container-collapsed{min-width:0!important;width:56px!important;height:56px!important;padding:0!important;border-radius:50%!important;display:flex!important;align-items:center!important;justify-content:center!important;margin:0!important;gap:0!important}.divee-widget-floating .divee-icon-ai-collapsed{display:block!important;width:28px!important;height:28px!important}.divee-widget-floating .divee-icon-site-collapsed,.divee-widget-floating .divee-search-input-collapsed,.divee-widget-floating .divee-send-icon-collapsed{display:none!important}.divee-widget-floating[data-state=expanded]{width:calc(100vw - 16px)!important;max-width:500px!important;height:auto!important;max-height:105vh!important;bottom:8px!important;border-radius:16px!important}.divee-widget-floating[data-floating-position=bottom-right]{right:8px!important}.divee-widget-floating[data-floating-position=bottom-left]{left:8px!important}.divee-widget-floating .divee-expanded{max-height:105vh!important;height:auto!important;border-radius:16px!important}.divee-widget-floating .divee-header{padding:16px 20px 10px!important;margin-bottom:8px!important}.divee-widget-floating .divee-content{padding:10px!important;gap:12px!important}}.divee-widget[dir=rtl] .divee-search-input-collapsed{text-align:right;direction:rtl}.divee-widget[dir=rtl] .divee-send-icon-collapsed{transform:scaleX(-1)}.divee-widget[dir=rtl] .divee-search-container-collapsed:hover .divee-send-icon-collapsed{transform:scaleX(-1) translate(-2px) scale(1.15)}@media(max-width:768px){.divee-chat{min-height:220px!important;height:auto!important;flex:1!important}.divee-widget-floating .divee-content{padding:6px!important;gap:10px!important}.divee-widget-floating .divee-chat{padding:6px!important;margin-bottom:2px!important}.divee-widget-floating .divee-messages{gap:8px!important}.divee-widget-floating .divee-message{max-width:92%!important}.divee-widget-floating .divee-message-content{padding:8px 10px!important}.divee-widget-floating .divee-header{padding:12px 8px 8px!important;margin-bottom:4px!important}.divee-widget-floating .divee-powered-by{font-size:12px!important;padding:0 4px!important}.divee-widget-floating .divee-close{font-size:18px!important;padding:2px 6px!important}.divee-widget-floating .divee-title{font-size:14px!important}.divee-widget-floating .divee-header-top{gap:8px!important}.divee-widget-floating .divee-icon-site{width:28px!important;height:28px!important}.divee-widget-floating .divee-empty-state{padding:12px!important}.divee-widget-floating .divee-input-container{padding:6px 3px!important;gap:8px!important;margin-left:5px!important;margin-right:5px!important}.divee-widget-floating .divee-suggestions-input{margin-bottom:8px!important}.divee-widget-floating .divee-suggestions-list{padding:6px!important}.divee-widget-floating .divee-suggestion{padding:8px 10px!important}}
`,document.head.appendChild(f)})();function I(f){const m=["article",".article-content","[role='main']","main",".post-content",".entry-content",".content"],C=()=>{if(f){const l=document.querySelector(f);if(l)return l}for(const l of m){const d=document.querySelector(l);if(d)return d}return document.body},e=(l,d)=>!!l.closest(d),t=(l,d)=>{const u=l.previousElementSibling?.tagName?.toLowerCase(),v=l.nextElementSibling?.tagName?.toLowerCase();if(u==="figcaption"||v==="figcaption"||d.length<100&&(u==="img"||v==="img"))return!0;const x=!!l.querySelector("i, em"),_=!!l.querySelector("small"),y=(l.getAttribute("style")||"").toLowerCase(),k=(l.className||"").toLowerCase();return(x||_)&&d.length<150||k.includes("caption")||k.includes("credit")||k.includes("source")||y.includes("font-size")&&y.includes("small")},i=(l,d)=>{if(!d)return 0;const u=l.getElementsByTagName("a");if(!u.length)return 0;let v=0;for(const x of u)v+=(x.textContent||"").trim().length;return v/d.length},o=(l,d)=>{const u=d.toLowerCase();if([/\badvertisement\b/,/\bsponsored\b/,/\bpromotion\b/,/\bpartner content\b/,/\baffiliate\b/,/\bcontinue reading below\b/,/\bread more\b/,/\bclick here\b/,/\bsign up for\b/,/\bsubscribe to\b/,/\bnewsletter\b/,/special offer/,/limited time/,/\bdiscount\b/,/\bsale\b.*\bends\b/].some(b=>b.test(u)))return!0;const x=(l.className||"").toLowerCase(),_=(l.id||"").toLowerCase(),y=(l.parentElement?.className||"").toLowerCase();if(["ad","ads","advertisement","sponsor","promoted","promo","banner","commercial","widget","sidebar","related","recommended"].some(b=>x.includes(b)||_.includes(b)||y.includes(b)))return!0;const S=Array.from(l.getElementsByTagName("a"));return S.length===1&&(S[0].textContent||"").trim()===d?!0:S.some(b=>{const A=b.getAttribute("href")||"";return A.includes("utm_")||A.includes("ref=")||A.includes("click=")||A.includes("campaign=")})},s=(()=>{try{if(typeof Readability!="function")return null;const l=document.cloneNode(!0),d=new Readability(l).parse();return d?{title:d.title||document.title||"Untitled",content:d.content||""}:null}catch{return null}})(),a=C(),r=s?.content||a.innerHTML,c=document.createElement("div");c.innerHTML=r;let g=Array.from(c.querySelectorAll("p")).filter(l=>(l.textContent||"").trim().length>0);g.length<3&&(g=Array.from(c.querySelectorAll("span, div")).filter(l=>(l.textContent||"").trim().length>30).filter(l=>!l.querySelector("p")));const p=[],h={empty:0,insideFigure:0,insideAside:0,caption:0,highLinkDensity:0,adContent:0,tooShort:0};for(const l of g){const d=(l.textContent||"").trim();if(!d){h.empty++;continue}if(e(l,"figure")){h.insideFigure++;continue}if(e(l,"aside")){h.insideAside++;continue}if(t(l,d)){h.caption++;continue}if(i(l,d)>.8){h.highLinkDensity++;continue}if(o(l,d)){h.adContent++;continue}if(d.length<20){h.tooShort++;continue}p.push(d)}return p.join(`

`)}function E(){try{if(typeof Readability=="function"){const f=document.cloneNode(!0),m=new Readability(f).parse();if(m&&m.title)return m.title}}catch{}return document.title||"Untitled"}function D(){return window.location.href}(function(){"use strict";class f{constructor(e){this.config={projectId:e.projectId,cachedBaseUrl:e.cachedBaseUrl||"https://cdn.divee.ai/functions/v1",nonCacheBaseUrl:e.nonCacheBaseUrl||"https://srv.divee.ai/functions/v1",displayMode:"anchored",floatingPosition:"bottom-right",anchoredPosition:"bottom",articleClass:null,containerSelector:null},this.state={isExpanded:!1,isStreaming:!1,suggestions:[],messages:[],serverConfig:null,conversationId:null,aiResponseCount:0,suggestionsSuppressed:!1,widgetVisibleTracked:!1,adRefreshInterval:null},this.analyticsQueue=[],this.analyticsFlushTimer=null,this.analyticsConfig={maxBatchSize:10,flushInterval:3e3,immediateEvents:["widget_loaded","impression","widget_visible"]},this.elements={},this.contentCache={content:null,title:null,url:null,image_url:null,og_image:null,extracted:!1,articleFound:!1},this.checkSuggestionsSuppression(),this.init()}isDebugMode(){return new URLSearchParams(window.location.search).get("diveeDebug")==="true"}checkSuggestionsSuppression(){const e=`divee_suggestions_suppressed_${window.location.href}`;this.state.suggestionsSuppressed=sessionStorage.getItem(e)==="true"}suppressSuggestions(){const e=`divee_suggestions_suppressed_${window.location.href}`;sessionStorage.setItem(e,"true"),this.state.suggestionsSuppressed=!0}log(...e){this.isDebugMode()&&console.log("[Divee]",...e)}generateUUID(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,i=e=="x"?t:t&3|8;return i.toString(16)})}getAnalyticsIds(){let e=localStorage.getItem("divee_visitor_id");e||(e=this.generateUUID(),localStorage.setItem("divee_visitor_id",e));let t=this.generateUUID();this.state.visitorId=e,this.state.sessionId=t;const i=`divee_conversation_${window.location.href}`;return sessionStorage.removeItem(i),{visitorId:e,sessionId:t}}initGoogleAds(){if(window.googletag&&window.googletag._initialized_by_divee){this.log("Ads already initialized, skipping");return}this.log("Initializing Google Ads...");const e=this,t=this.state.serverConfig?.ad_tag_id;if(!t){this.log("No ad_tag_id in server config, skipping ads");return}const i="22247219933",o=`/${i},${t}/Divee/Desktop`,n=`/${i},${t}/Divee/mobileweb`,s=window.googletag&&window.googletag.apiReady;if(this.log("GPT preloaded:",s,"Ad tag:",t),this._gptAlreadyLoaded=s,window.googletag=window.googletag||{cmd:[]},window.googletag._initialized_by_divee=!0,!s){const a=document.createElement("script");a.async=!0,a.src="https://securepubads.g.doubleclick.net/tag/js/gpt.js",a.crossOrigin="anonymous",a.onload=()=>e.log("\u2713 GPT script loaded"),a.onerror=()=>console.error("[Divee] Failed to load GPT script"),document.head.appendChild(a)}googletag.cmd.push(function(){let a=[[970,250],[728,90],[468,60],[300,250]],r=[[728,90],[468,60],[300,250]],c=[[336,280],[320,250],[300,250],[320,100],[300,100],[320,50],[300,50]];if(e.state.serverConfig?.override_desktop_ad_size)try{const d=JSON.parse(e.state.serverConfig.override_desktop_ad_size);Array.isArray(d)&&d.length>0&&(a=d,r=d.filter(u=>u[0]<=728),e.log("Using override desktop ad sizes:",a))}catch(d){console.error("[Divee] Failed to parse override_desktop_ad_size:",d)}if(e.state.serverConfig?.override_mobile_ad_size)try{const d=JSON.parse(e.state.serverConfig.override_mobile_ad_size);Array.isArray(d)&&d.length>0&&(c=d,e.log("Using override mobile ad sizes:",c))}catch(d){console.error("[Divee] Failed to parse override_mobile_ad_size:",d)}const g=googletag.sizeMapping().addSize([1024,0],a).addSize([768,0],r).addSize([0,0],[]).build(),p=googletag.sizeMapping().addSize([768,0],[]).addSize([0,0],c).build(),h=googletag.defineSlot(o,a,"div-gpt-ad-1770993606680-0");h?(h.defineSizeMapping(g),h.addService(googletag.pubads())):console.error("[Divee] Failed to define desktop slot");const w=googletag.defineSlot(n,c,"div-gpt-ad-1770993160534-0");w?(w.defineSizeMapping(p),w.addService(googletag.pubads())):console.error("[Divee] Failed to define mobile slot"),e.log("\u2713 Ad slots defined"),googletag.pubads().collapseEmptyDivs(),googletag.pubads().enableLazyLoad({fetchMarginPercent:200,renderMarginPercent:100,mobileScaling:2}),googletag.pubads().setTargeting("content_type","article"),googletag.pubads().setTargeting("display_mode",e.config.displayMode||"anchored"),googletag.enableServices(),e._gptAlreadyLoaded&&(e._needsSlotRefresh=!0),e.log("\u2713 Ads initialized")})}async init(){if(this.log("Initializing widget...",this.config),this.getAnalyticsIds(),await this.loadServerConfig(),this.initGoogleAds(),!this.state.serverConfig){this.log("Widget disabled due to config load failure");return}if(!this.extractArticleContent()){this.log("Widget disabled: article element not found");return}if(!this.articleContent||this.articleContent.trim().length<100){this.log("Widget disabled: article content is empty or too short",{contentLength:this.articleContent?.length||0});return}this.createWidget(),this.attachEventListeners(),this.setupVisibilityTracking(),this.setupPageUnloadFlush(),this.trackEvent("widget_loaded",{project_id:this.config.projectId,article_id:this.config.articleId,position:this.config.position})}async loadServerConfig(){try{const e=await this.fetchServerConfig(this.config.projectId);this.trackEvent("impression",{url:this.contentCache.url||window.location.href,referrer:document.referrer}),this.state.serverConfig=e,this.log("Server config loaded:",this.state.serverConfig),e.display_mode&&(this.config.displayMode=e.display_mode,this.log("Display mode from config:",e.display_mode)),e.display_position&&(this.config.displayMode==="floating"?(this.config.floatingPosition=e.display_position,this.log("Floating position from config:",e.display_position)):(this.config.anchoredPosition=["top","bottom"].includes(e.display_position)?e.display_position:"bottom",this.log("Anchored position from config:",this.config.anchoredPosition))),e.anchored_position&&(this.config.anchoredPosition=["top","bottom"].includes(e.anchored_position)?e.anchored_position:"bottom",this.log("Anchored position override from config:",this.config.anchoredPosition)),e.article_class&&(this.config.articleClass=e.article_class,this.log("Article class from config:",e.article_class)),window.innerWidth<768&&e.override_mobile_container_selector?(this.config.containerSelector=e.override_mobile_container_selector,this.log("Container selector from mobile override:",e.override_mobile_container_selector)):e.widget_container_class&&(this.config.containerSelector=e.widget_container_class,this.log("Container selector from config:",e.widget_container_class)),e.direction&&this.elements.container?.setAttribute("dir",e.direction),e.language&&this.elements.container?.setAttribute("lang",e.language),this.applyThemeColors(e);const i=new URLSearchParams(window.location.search),o=i.get("diveeOverrideDisplayMode"),n=i.get("diveeOverrideDisplayPosition"),s=i.get("diveeOverrideArticleClass"),a=i.get("diveeOverrideContainerSelector");(o||n||s||a)&&this.log("URL param overrides detected:",{displayMode:o,displayPosition:n,articleClass:s,containerSelector:a}),o&&(this.config.displayMode=o,this.log("Display mode overridden by URL param:",o)),n&&(this.config.floatingPosition=n,["top","bottom"].includes(n)&&(this.config.anchoredPosition=n),this.log("Display position overridden by URL param:",n)),s&&(this.config.articleClass=s,this.log("Article class overridden by URL param:",s)),a&&(this.config.containerSelector=a,this.log("Container selector overridden by URL param:",a)),this.log("Final config after overrides:",{displayMode:this.config.displayMode,floatingPosition:this.config.floatingPosition,anchoredPosition:this.config.anchoredPosition,articleClass:this.config.articleClass,containerSelector:this.config.containerSelector})}catch(e){console.error("[Divee] Failed to load config:",e),this.state.serverConfig=null}}applyThemeColors(e){if(!this.elements.container)return;const t=e?.highlight_color||this.getDefaultConfig().highlight_color;Array.isArray(t)&&t.length>=2&&(this.elements.container.style.setProperty("--divee-color-primary",t[0]),this.elements.container.style.setProperty("--divee-color-secondary",t[1]),this.log("Applied theme colors:",t[0],t[1]))}async fetchServerConfig(e){if(!this.config.cachedBaseUrl)throw new Error("Missing cachedBaseUrl");const t=`${this.config.cachedBaseUrl}/config?projectId=${encodeURIComponent(e)}`,i=await fetch(t,{method:"GET"});if(!i.ok)throw new Error(`Config request failed: ${i.status}`);return i.json()}getDefaultConfig(){return{direction:"ltr",language:"en",icon_url:"https://images.icon-icons.com/167/PNG/512/cnn_23166.png",client_name:"Demo Site",client_description:"Article Assistant",highlight_color:["#68E5FD","#A389E0"],show_ad:!0,input_text_placeholders:["Ask anything about this article..."]}}extractArticleContent(){if(this.contentCache.extracted)return this.log("Using cached content"),this.articleTitle=this.contentCache.title,this.articleContent=this.contentCache.content,this.contentCache.articleFound;let e=!1;try{typeof E=="function"?this.articleTitle=E():this.articleTitle=document.title||document.querySelector("h1")?.textContent||"Untitled Article";let t=null;this.config.articleClass&&(t=document.querySelector(this.config.articleClass)),t||(t=document.querySelector("article")||document.querySelector('[role="article"]')||document.querySelector("main")),t?e=!0:(this.log("No article element found, widget will not render"),e=!1),typeof I=="function"?this.articleContent=I(this.config.articleClass):this.articleContent=t?t.textContent.trim():"",typeof D=="function"?this.articleUrl=D():this.articleUrl=window.location.href;const i=document.querySelector('meta[property="og:image"]')?.getAttribute("content")||document.querySelector('meta[name="twitter:image"]')?.getAttribute("content")||null,o=document.querySelector("article img")?.src||document.querySelector('[role="article"] img')?.src||null;return this.contentCache={content:this.articleContent,title:this.articleTitle,url:this.articleUrl,image_url:o,og_image:i,extracted:!0,articleFound:e},this.log("Article extracted and cached:",{title:this.articleTitle,url:this.articleUrl,contentLength:this.articleContent.length,articleFound:e,hasOgImage:!!i,hasArticleImage:!!o}),e}catch(t){return console.error("[Divee] Error extracting content:",t),this.contentCache={content:"",title:document.title||"Untitled Article",url:window.location.href,image_url:null,og_image:null,extracted:!0,articleFound:!1},!1}}createWidget(){this.log("createWidget called with config:",{displayMode:this.config.displayMode,floatingPosition:this.config.floatingPosition,anchoredPosition:this.config.anchoredPosition});const e=document.createElement("div");e.className="divee-widget",e.setAttribute("data-state","collapsed"),this.config.displayMode==="floating"?(this.log("Applying floating mode with position:",this.config.floatingPosition),e.classList.add("divee-widget-floating"),e.setAttribute("data-floating-position",this.config.floatingPosition)):this.log("Anchored mode, position:",this.config.anchoredPosition);const t=this.state.serverConfig||this.getDefaultConfig();t.direction&&e.setAttribute("dir",t.direction);const i=this.createCollapsedView();e.appendChild(i);const o=this.createExpandedView();o.style.display="none",e.appendChild(o);const n=t.show_ad&&t.ad_tag_id&&this.config.displayMode!=="floating",s=document.createElement("div");s.className="divee-ad-container-shared",s.style.display="none",s.innerHTML=`
                <div class="divee-ad-slot divee-ad-slot-shared" ${n?"":'style="display: none;"'}>
                    <!-- Desktop Ad -->
                    <div id='div-gpt-ad-1770993606680-0' class='divee-ad-desktop' style='display: none; min-width: 300px; min-height: 60px; margin: 0 !important;'></div>
                    <!-- Mobile Ad -->
                    <div id='div-gpt-ad-1770993160534-0' class='divee-ad-mobile' style='display: none; min-width: 300px; min-height: 50px;'></div>
                </div>
            `,e.appendChild(s),this.elements.container=e,this.elements.collapsedView=i,this.elements.expandedView=o,this.elements.adContainer=s,this.applyThemeColors(this.state.serverConfig||this.getDefaultConfig()),this.insertWidget(e)}createCollapsedView(){const e=document.createElement("div");e.className="divee-collapsed";const t=this.state.serverConfig||this.getDefaultConfig(),i=t.show_ad&&t.ad_tag_id&&this.config.displayMode!=="floating"?"":'style="display: none;"';return e.innerHTML=`
                <div class="divee-powered-by-collapsed">
                    <a class="divee-powered-by" href="https://www.divee.ai" target="_blank" rel="noopener noreferrer">powered by divee.ai</a>
                </div>
                <div class="divee-search-container-collapsed">
                    <img class="divee-icon-ai-collapsed" src="https://srv.divee.ai/storage/v1/object/public/public-files/ai.png" alt="AI icon" />
                    <img class="divee-icon-site-collapsed" src="${t.icon_url}" alt="Site icon" />
                    <input type="text" class="divee-search-input-collapsed" placeholder="" readonly />
                    <svg class="divee-send-icon-collapsed" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </div>
      `,setTimeout(()=>{const o=e.querySelector(".divee-search-input-collapsed");o&&t.input_text_placeholders&&this.typewriterEffect(o,t.input_text_placeholders)},500),e}typewriterEffect(e,t){if(!e||!t||t.length===0)return;let i=0,o=0;const n=50,s=30,a=2e3,r=500,c=()=>{const p=String(t[i]||"");o<p.length?(e.placeholder=p.substring(0,o+1),o++,setTimeout(c,n+Math.random()*30)):setTimeout(g,a)},g=()=>{const p=String(t[i]||"");o>0?(e.placeholder=p.substring(0,o-1),o--,setTimeout(g,s)):(i=(i+1)%t.length,setTimeout(c,r))};c()}createEmptyState(e){const t=document.createElement("div");t.className="divee-empty-state";const i=e.input_text_placeholders||["Ask anything about this article..."],o=i.length>0?i[0]:"Ask me anything about this article";return t.innerHTML=`
                <div class="divee-empty-icon">
                    <img src="${e.icon_url}" alt="AI" />
                </div>
            `,t}createExpandedView(){const e=document.createElement("div");e.className="divee-expanded";const t=this.state.serverConfig||this.getDefaultConfig(),i=t.input_text_placeholders&&t.input_text_placeholders.length>0?t.input_text_placeholders[0]:"Ask anything about this article...";e.innerHTML=`
                <div class="divee-header">
                    <div class="divee-header-top">
                        <div class="divee-icons">
                            <img class="divee-icon-site-collapsed" src="https://srv.divee.ai/storage/v1/object/public/public-files/ai.png" alt="AI icon" />
                            <img class="divee-icon-site" src="${t.icon_url}" alt="Site icon" />
                        </div>
                        <span class="divee-title">${t.client_name}</span>
                        <a class="divee-powered-by" href="https://www.divee.ai" target="_blank" rel="noopener noreferrer">powered by divee.ai</a>
                        <button class="divee-close" aria-label="Close">\u2715</button>
                    </div>
                </div>
                <div class="divee-content">
                    <div class="divee-chat">
                        <div class="divee-messages"></div>
          </div>
                    <div class="divee-input-container">
                        <div class="divee-suggestions-input" style="display: none;">
                            <div class="divee-suggestions-list"></div>
                        </div>
            <textarea 
                            class="divee-input" 
              placeholder="${i}"
              rows="1"
              maxlength="200"
            ></textarea>
                        <button class="divee-send" aria-label="Send">
              <svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
            <div class="divee-input-footer">
                <div class="divee-warning">${t.disclaimer_text||"This is an AI driven tool, results might not always be accurate"}</div>
                <div class="divee-counter">0/200</div>
            </div>
          </div>
        </div>
      `,setTimeout(()=>{const n=e.querySelector(".divee-input");n&&t.input_text_placeholders&&this.typewriterEffect(n,t.input_text_placeholders)},500);const o=e.querySelector(".divee-messages");if(this.state.messages.length===0){const n=this.createEmptyState(t);o.appendChild(n)}return e}insertWidget(e){if(this.log("insertWidget called with config:",{displayMode:this.config.displayMode,anchoredPosition:this.config.anchoredPosition,containerSelector:this.config.containerSelector}),this.log("Display mode:",this.config.displayMode),this.log("Config containerSelector (from server):",this.config.containerSelector),this.config.displayMode==="floating"){this.log("Floating mode: appending to body"),document.body.appendChild(e),this.displayAdsIfNeeded();return}let t=null;this.config.containerSelector?(this.log("\u2713 Using containerSelector from server config:",this.config.containerSelector),this.log("Attempting to find element with querySelector:",this.config.containerSelector),t=document.querySelector(this.config.containerSelector),t?this.log("\u2713 Found custom container element:",{selector:this.config.containerSelector,tagName:t.tagName,className:t.className,id:t.id}):this.log(`\u2717 Container selector "${this.config.containerSelector}" not found in DOM, falling back to default behavior`)):this.log("No containerSelector from server config, using default auto-detection"),t||(this.log('Looking for default containers (article, [role="article"], main)'),t=document.querySelector("article")||document.querySelector('[role="article"]')||document.querySelector("main"),t?this.log("\u2713 Found default container:",t.tagName,t.className):this.log("\u2717 No default container found, will append to body")),t?(this.log("Inserting widget to target element, position:",this.config.anchoredPosition),this.config.anchoredPosition==="top"?(this.log("Using prepend() for top position"),t.prepend(e)):(this.log("Using appendChild() for bottom position"),t.appendChild(e))):(this.log("No suitable container found, appending to body as fallback"),this.config.anchoredPosition==="top"?document.body.prepend(e):document.body.appendChild(e)),this.displayAdsIfNeeded()}displayAdsIfNeeded(){const e=this.state.serverConfig||this.getDefaultConfig();if(e.show_ad&&window.googletag){const t=this;googletag.cmd.push(function(){if(googletag.display("div-gpt-ad-1770993606680-0"),googletag.display("div-gpt-ad-1770993160534-0"),t.log("\u2713 Ad slots displayed"),t._needsSlotRefresh){const r=googletag.pubads().getSlots().filter(c=>{const g=c.getSlotElementId();return g==="div-gpt-ad-1770993606680-0"||g==="div-gpt-ad-1770993160534-0"});r.length>0&&(googletag.pubads().refresh(r),t.log("\u2713 Refreshed pre-loaded slots")),t._needsSlotRefresh=!1}let i=0;const o=["div-gpt-ad-1770993606680-0","div-gpt-ad-1770993160534-0"],n=document.querySelector(".divee-ad-slot-shared"),s=document.querySelector(".divee-ad-container-shared"),a={};googletag.pubads().addEventListener("slotRenderEnded",function(r){const c=r.slot.getSlotElementId();if(!o.includes(c))return;const g=document.getElementById(c);a[c]=!r.isEmpty,r.isEmpty?(g&&(g.style.display="none"),i++,t.trackEvent("ad_unfilled",{ad_unit:c,position:"collapsed",reason:"no_fill"}),Object.keys(a).length===o.length&&Object.values(a).every(p=>!p)&&(n&&(n.style.display="none"),s&&(s.style.display="none"))):(g&&(g.style.display=""),n&&(n.style.display=""),s&&(s.style.display=""),t.trackEvent("ad_impression",{ad_unit:c,position:"collapsed",size:r.size?`${r.size[0]}x${r.size[1]}`:"unknown",advertiser_id:r.advertiserId||null,creative_id:r.creativeId||null,line_item_id:r.lineItemId||null}),g&&t.setupAdClickTracking(g,c,r))}),t.startAdAutoRefresh()})}else this.log("WARNING: Ads NOT displayed!"),this.log("WARNING: Reason:",e.show_ad?"googletag not available":"show_ad is false in config"),this.log("WARNING: config.show_ad:",e.show_ad),this.log("WARNING: window.googletag:",!!window.googletag)}startAdAutoRefresh(){this.state.adRefreshInterval&&clearInterval(this.state.adRefreshInterval);const e=this,t=6e4;this.state.adRefreshInterval=setInterval(()=>{if(!this.isWidgetInViewport()){this.log("Ad refresh skipped: widget not near viewport");return}if(!window.googletag||!window.googletag.pubads){this.log("Ad refresh skipped: googletag not ready");return}googletag.cmd.push(function(){if(!e.isWidgetInViewport()){e.log("Ad refresh skipped: widget not near viewport (cmd)");return}const n=googletag.pubads().getSlots().filter(s=>s.getSlotElementId().startsWith("div-gpt-ad-")).filter(s=>{const a=document.getElementById(s.getSlotElementId());if(!a)return!1;const r=window.getComputedStyle(a);if(r.display==="none"||r.visibility==="hidden")return!1;const c=a.getBoundingClientRect();return c.top<window.innerHeight&&c.bottom>0&&c.width>0&&c.height>0});n.length>0&&(googletag.pubads().refresh(n),e.log("\u2713 Auto-refreshed",n.length,"ad(s)"),e.trackEvent("ad_auto_refresh",{slots_refreshed:n.map(s=>s.getSlotElementId()),count:n.length,interval_ms:t}))})},t)}isWidgetInViewport(e=200){const t=this.elements.container;if(!t)return!1;const i=window.getComputedStyle(t);if(i.display==="none"||i.visibility==="hidden"||i.opacity==="0")return!1;const o=t.getBoundingClientRect(),n=window.innerHeight||document.documentElement.clientHeight,s=window.innerWidth||document.documentElement.clientWidth;return o.bottom>-e&&o.right>-e&&o.top<n+e&&o.left<s+e&&o.width>0&&o.height>0}stopAdAutoRefresh(){this.state.adRefreshInterval&&(clearInterval(this.state.adRefreshInterval),this.state.adRefreshInterval=null)}attachEventListeners(){this.elements.collapsedView.addEventListener("click",()=>this.expand()),this.elements.expandedView.querySelector(".divee-close").addEventListener("click",o=>{o.stopPropagation(),this.collapse()});const t=this.elements.expandedView.querySelector(".divee-input");t.addEventListener("focus",()=>this.onTextAreaFocus()),t.addEventListener("click",()=>this.onTextAreaFocus()),t.addEventListener("input",o=>{this.autoResizeTextarea(o.target),this.updateCharacterCounter(o.target)}),document.addEventListener("click",o=>{const n=this.elements.expandedView.querySelector(".divee-suggestions-input"),s=this.elements.expandedView.querySelector(".divee-input-container");n&&n.classList.contains("is-open")&&!s.contains(o.target)&&n.classList.remove("is-open")}),this.elements.expandedView.querySelector(".divee-send").addEventListener("click",()=>this.sendQuestion()),t.addEventListener("keydown",o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),this.sendQuestion())})}expand(){this.state.isExpanded=!0,this.elements.container.setAttribute("data-state","expanded"),this.elements.expandedView.style.display="block",this.elements.expandedView.style.opacity="0",this.elements.expandedView.style.transform="translateY(10px)",this.elements.collapsedView.style.opacity="0",setTimeout(()=>{this.elements.collapsedView.style.display="none",this.elements.expandedView.style.opacity="1",this.elements.expandedView.style.transform="translateY(0)"},150),this.trackEvent("widget_expanded",{trigger:"click"}),setTimeout(()=>{this.elements.expandedView.querySelector(".divee-input").focus()},300)}collapse(){this.state.isExpanded=!1,this.elements.container.setAttribute("data-state","collapsed"),this.elements.expandedView.style.opacity="0",this.elements.expandedView.style.transform="translateY(10px)",setTimeout(()=>{this.elements.expandedView.style.display="none",this.elements.collapsedView.style.display="block",this.elements.collapsedView.style.opacity="0",setTimeout(()=>{this.elements.collapsedView.style.opacity="1"},50)},200),this.trackEvent("widget_collapsed",{time_spent:Date.now(),questions_asked:this.state.messages.filter(e=>e.role==="user").length})}async onTextAreaFocus(){const e=this.elements.expandedView.querySelector(".divee-suggestions-input");if(this.state.suggestions.length>0){e&&!e.classList.contains("is-open")&&(e.style.display="block",e.classList.add("is-open"),this.trackEvent("suggestions_reopened",{count:this.state.suggestions.length}));return}this.trackEvent("textarea_focused",{timestamp:Date.now()});const t=e?.querySelector(".divee-suggestions-list");e&&t&&(e.style.display="block",e.classList.add("is-open"),t.innerHTML=`
        <div class="divee-suggestion divee-loading-item"><div class="divee-shimmer-line"></div></div>
        <div class="divee-suggestion divee-loading-item"><div class="divee-shimmer-line"></div></div>
        <div class="divee-suggestion divee-loading-item"><div class="divee-shimmer-line"></div></div>
      `);try{const i=await this.fetchSuggestions();if(this.state.suggestions=i,!t)return;t.innerHTML="",i.forEach((o,n)=>{const s=typeof o=="string"?o:o.question,a=typeof o=="string"?null:o.id,r=document.createElement("button");r.className="divee-suggestion",r.setAttribute("data-index",n),a&&r.setAttribute("data-id",a),r.textContent=s,r.addEventListener("click",c=>{const g=c.target.textContent,p=c.target.getAttribute("data-id");this.askQuestion(g,"suggestion",p)}),t.appendChild(r)}),this.trackEvent("suggestions_fetched",{article_id:this.config.articleId,suggestions_count:i.length,load_time:0})}catch(i){console.error("[Divee] Failed to fetch suggestions:",i),t&&(t.innerHTML='<div class="divee-error">Could not load suggestions</div>')}}async fetchSuggestions(){const e={projectId:this.config.projectId,articleId:this.config.articleId,title:this.contentCache.title,url:this.contentCache.url,content:this.contentCache.content,visitor_id:this.state.visitorId,session_id:this.state.sessionId,metadata:{image_url:this.contentCache.image_url,og_image:this.contentCache.og_image}};try{const t=await fetch(`${this.config.nonCacheBaseUrl}/suggestions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Suggestions request failed: ${t.status}`);const i=await t.json();if(Array.isArray(i?.suggestions))return i.suggestions}catch(t){console.error("[Divee] Suggestions request failed:",t)}return[]}sendQuestion(){const e=this.elements.expandedView.querySelector(".divee-input"),t=e.value.trim();if(!t)return;this.askQuestion(t,"custom",null),e.value="",e.style.height="auto";const i=this.elements.expandedView.querySelector(".divee-counter");i&&(i.textContent="0/200")}async askQuestion(e,t,i){const o=this.elements.expandedView.querySelector(".divee-suggestions-input");o&&o.classList.remove("is-open"),this.addMessage("user",e),this.state.isStreaming=!0;const n=this.addMessage("ai","",!0);try{await this.streamResponse(e,n,i)}catch(s){console.error("[Divee] Failed to get answer:",s),this.updateMessage(n,"Sorry, I encountered an error. Please try again.")}finally{this.state.isStreaming=!1}}addMessage(e,t,i=!1){const o=this.elements.expandedView.querySelector(".divee-messages"),n=o.querySelector(".divee-empty-state");n&&n.remove();const s=this.elements.expandedView.querySelector(".divee-chat"),a=`msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,r=document.createElement("div");r.className=`divee-message divee-message-${e}`,r.setAttribute("data-message-id",a);const c=document.createElement("div");if(c.className="divee-message-label",e==="user")c.textContent="You";else{const p=this.state.serverConfig||this.getDefaultConfig();c.innerHTML=`<img class="divee-message-icon" src="${p.icon_url}" alt="AI" />`}const g=document.createElement("div");if(g.className="divee-message-content",g.textContent=t,i){const p=document.createElement("span");p.className="divee-cursor",p.textContent="\u258A",g.appendChild(p)}return r.appendChild(c),r.appendChild(g),o.appendChild(r),s.scrollTop=s.scrollHeight,this.state.messages.push({id:a,role:e,content:t}),a}updateMessage(e,t,i=!1){const o=this.elements.expandedView.querySelector(`[data-message-id="${e}"]`);if(!o)return;const n=o.querySelector(".divee-message-content"),s=n.querySelector(".divee-cursor");if(i){const r=document.createTextNode(t);s?n.insertBefore(r,s):n.appendChild(r)}else s&&s.remove(),n.textContent=t;const a=this.elements.expandedView.querySelector(".divee-chat");a.scrollTop=a.scrollHeight}async simulateStreaming(e,t){for(let o=0;o<t.length;o+=4){const n=t.slice(o,o+4);this.updateMessage(e,n,!0),await new Promise(s=>setTimeout(s,15))}}async streamResponse(e,t,i){const o={projectId:this.config.projectId,questionId:i||`q-${Date.now()}`,question:e,title:this.contentCache.title,url:this.contentCache.url,content:this.contentCache.content,visitor_id:this.state.visitorId,session_id:this.state.sessionId,conversation_id:this.state.conversationId,metadata:{image_url:this.contentCache.image_url,og_image:this.contentCache.og_image}},n=await fetch(`${this.config.nonCacheBaseUrl}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!n.ok){if(n.status===403){this.updateMessage(t,"Free form questions are currently not supported.");const p=this.elements.expandedView.querySelector(`[data-message-id="${t}"]`)?.querySelector(".divee-cursor");p&&p.remove();return}if(n.status===429){const g=await n.json().catch(()=>({}));this.updateMessage(t,g.error||"Too many requests. Please try again later.");const h=this.elements.expandedView.querySelector(`[data-message-id="${t}"]`)?.querySelector(".divee-cursor");h&&h.remove();return}throw new Error(`Chat request failed: ${n.status}`)}const s=n.headers.get("X-Conversation-Id");if(s&&!this.state.conversationId&&(this.state.conversationId=s),(n.headers.get("content-type")||"").includes("application/json")){const g=await n.json();g?.answer&&await this.simulateStreaming(t,g.answer)}else if(n.body){const g=n.body.getReader(),p=new TextDecoder;let h="";for(;;){const{value:w,done:l}=await g.read();if(l)break;h+=p.decode(w,{stream:!0});const d=h.split(`

`);h=d.pop()||"";for(const u of d){const v=u.split(`
`);for(const x of v){const _=x.trim();if(!_.startsWith("data:"))continue;const y=_.replace(/^data:\s*/,"");if(y!=="[DONE]")try{const S=JSON.parse(y)?.choices?.[0]?.delta?.content;S&&this.updateMessage(t,S,!0)}catch{}}}}}const c=this.elements.expandedView.querySelector(`[data-message-id="${t}"]`)?.querySelector(".divee-cursor");c&&c.remove(),this.state.aiResponseCount++,await this.maybeShowSuggestionCard()}async maybeShowSuggestionCard(){!this.state.suggestionsSuppressed&&this.state.aiResponseCount%2===0&&await this.showSuggestionCard()}async fetchSuggestedArticle(){const e={projectId:this.config.projectId,currentUrl:this.contentCache.url,conversationId:this.state.conversationId};try{const t=await fetch(`${this.config.nonCacheBaseUrl}/suggested-articles`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Suggested articles request failed: ${t.status}`);return(await t.json()).suggestion||null}catch(t){return console.error("[Divee] Failed to fetch suggested article:",t),null}}async showSuggestionCard(){const e=await this.fetchSuggestedArticle();if(!e)return;const t=this.elements.expandedView.querySelector(".divee-messages"),i=this.elements.expandedView.querySelector(".divee-chat"),o=`suggestion-${Date.now()}`,n=this.createSuggestionCard(e,o);t.appendChild(n),i.scrollTop=i.scrollHeight,this.trackEvent("suggestion_shown",{article_id:e.unique_id,conversation_id:this.state.conversationId,position_in_chat:this.state.aiResponseCount})}createSuggestionCard(e,t){const i=document.createElement("div");i.className="divee-suggestion-card",i.setAttribute("data-card-id",t),i.setAttribute("role","link"),i.setAttribute("tabindex","0"),i.setAttribute("aria-label",`Suggested article: ${e.title}`);const o=e.image_url||"https://srv.divee.ai/storage/v1/object/public/public-files/placeholder.jpg";return i.innerHTML=`
                <button class="divee-suggestion-dismiss" aria-label="Dismiss suggestion">\u2715</button>
                <div class="divee-suggestion-image">
                    <img src="${o}" alt="${e.title}" />
                </div>
                <div class="divee-suggestion-text">
                    <div class="divee-suggestion-label">DIVE DEEPER...</div>
                    <div class="divee-suggestion-title">${e.title}</div>
                </div>
            `,i.addEventListener("click",s=>{s.target.closest(".divee-suggestion-dismiss")||(this.trackEvent("suggestion_clicked",{article_id:e.unique_id,conversation_id:this.state.conversationId,position_in_chat:this.state.aiResponseCount}),window.open(e.url,"_blank"))}),i.addEventListener("keydown",s=>{(s.key==="Enter"||s.key===" ")&&!s.target.closest(".divee-suggestion-dismiss")&&(s.preventDefault(),this.trackEvent("suggestion_clicked",{article_id:e.unique_id,conversation_id:this.state.conversationId,position_in_chat:this.state.aiResponseCount}),window.open(e.url,"_blank"))}),i.querySelector(".divee-suggestion-dismiss").addEventListener("click",s=>{s.stopPropagation(),this.trackEvent("suggestion_x_clicked",{article_id:e.unique_id,conversation_id:this.state.conversationId,position_in_chat:this.state.aiResponseCount}),this.showDismissalConfirmation(i,t,e)}),i}showDismissalConfirmation(e,t,i){e.classList.add("divee-suggestion-dismissing"),e.innerHTML=`
                <div class="divee-suggestion-confirm">
                    <div class="divee-suggestion-confirm-title">Don't show suggestions in this chat?</div>
                    <div class="divee-suggestion-confirm-subtitle">(You'll miss related articles)</div>
                    <div class="divee-suggestion-confirm-actions">
                        <button class="divee-btn-ghost divee-cancel-dismiss">Cancel</button>
                        <button class="divee-btn-primary divee-confirm-dismiss">Yes, hide them</button>
                    </div>
                </div>
            `,e.querySelector(".divee-cancel-dismiss").addEventListener("click",s=>{s.stopPropagation(),this.trackEvent("suggestion_dismissed_cancelled",{article_id:i.unique_id,conversation_id:this.state.conversationId}),e.style.opacity="0",setTimeout(()=>e.remove(),200)}),e.querySelector(".divee-confirm-dismiss").addEventListener("click",s=>{s.stopPropagation(),this.trackEvent("suggestion_dismissed_confirmed",{article_id:i.unique_id,conversation_id:this.state.conversationId}),this.suppressSuggestions(),e.style.opacity="0",setTimeout(()=>e.remove(),200)})}autoResizeTextarea(e){e.style.height="auto",e.style.height=Math.min(e.scrollHeight,150)+"px"}updateCharacterCounter(e){const t=this.elements.expandedView.querySelector(".divee-counter");if(t){const i=e.value.length;t.textContent=`${i}/200`}}setupAdClickTracking(e,t,i){const o=this;e.addEventListener("click",()=>{}),setTimeout(()=>{const n=e.querySelector("iframe");n&&n.addEventListener("load",()=>{})},100)}trackEvent(e,t={}){this.log("[Divee Analytics]",e,t);const i=this.state.visitorId,o=this.state.sessionId,n=this.config.projectId;if(!n){console.warn("[Divee Analytics] No project ID available for tracking");return}if(!i||!o){console.warn("[Divee Analytics] Missing visitor or session IDs");return}const s={project_id:n,visitor_id:i,session_id:o,event_type:e,event_label:t.label||null,event_data:t,timestamp:Date.now()};if(this.analyticsConfig.immediateEvents.includes(e)){this.sendAnalyticsBatch([s]);return}if(this.analyticsQueue.push(s),this.log("[Divee Analytics] Queued event, queue size:",this.analyticsQueue.length),this.analyticsQueue.length>=this.analyticsConfig.maxBatchSize){this.flushAnalytics();return}this.scheduleAnalyticsFlush()}scheduleAnalyticsFlush(){this.analyticsFlushTimer&&clearTimeout(this.analyticsFlushTimer),this.analyticsFlushTimer=setTimeout(()=>{this.flushAnalytics()},this.analyticsConfig.flushInterval)}flushAnalytics(){if(this.analyticsFlushTimer&&(clearTimeout(this.analyticsFlushTimer),this.analyticsFlushTimer=null),this.analyticsQueue.length===0)return;const e=[...this.analyticsQueue];this.analyticsQueue=[],this.log("[Divee Analytics] Flushing batch of",e.length,"events"),this.sendAnalyticsBatch(e)}sendAnalyticsBatch(e){if(e.length!==0)try{const t=`${this.config.nonCacheBaseUrl}/analytics`,i=e.length===1?e[0]:{batch:e};fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),keepalive:!0}).catch(o=>{console.error("[Divee Analytics] Failed to send batch:",o)})}catch(t){console.error("[Divee Analytics] Error sending batch:",t)}}setupVisibilityTracking(){if(!this.elements.container||this.state.widgetVisibleTracked)return;const e=new IntersectionObserver(t=>{t.forEach(i=>{i.isIntersecting&&!this.state.widgetVisibleTracked&&(this.state.widgetVisibleTracked=!0,this.trackEvent("widget_visible",{url:this.contentCache.url||window.location.href,display_mode:this.config.displayMode,viewport_width:window.innerWidth,viewport_height:window.innerHeight}),this.log("Widget visible event fired"),e.disconnect())})},{threshold:.5});e.observe(this.elements.container)}setupPageUnloadFlush(){const e=()=>{if(this.stopAdAutoRefresh(),this.analyticsQueue.length>0){const t=[...this.analyticsQueue];this.analyticsQueue=[];const i=`${this.config.nonCacheBaseUrl}/analytics`,o=t.length===1?t[0]:{batch:t};if(navigator.sendBeacon)navigator.sendBeacon(i,JSON.stringify(o));else{const n=new XMLHttpRequest;n.open("POST",i,!1),n.setRequestHeader("Content-Type","application/json"),n.send(JSON.stringify(o))}}};window.addEventListener("pagehide",e),window.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&e()})}}function m(){const C=document.querySelectorAll("script[data-project-id]"),t=new URLSearchParams(window.location.search).get("diveeDebug")==="true";C.forEach((i,o)=>{const n={projectId:i.getAttribute("data-project-id"),cachedBaseUrl:"https://cdn.divee.ai/functions/v1",nonCacheBaseUrl:"https://srv.divee.ai/functions/v1"};if(t){const s=[{attr:"data-display-mode",msg:"Use display_mode in project settings"},{attr:"data-floating-position",msg:"Use display_position in project settings"},{attr:"data-article-class",msg:"Use article_class in project settings"},{attr:"data-container-selector",msg:"Use widget_container_class in project settings"}].filter(a=>i.getAttribute(a.attr));s.length>0&&console.warn("[Divee] Deprecated attributes:",s.map(a=>a.attr).join(", ")),console.log(`[Divee] Auto-init [${o}]:`,n)}new f(n)})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",m):m(),window.DiveeWidget=f})()})();
